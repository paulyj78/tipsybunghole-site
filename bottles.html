<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Tipsy Bunghole Bottles</title>
  <style>
    body {
      font-family: 'Courier New', Courier, monospace;
      background: url('https://firebasestorage.googleapis.com/v0/b/tipsy-bunghole-photos.appspot.com/o/IMG_0037.jpeg?alt=media&token=857fc39c-1247-45df-9fc7-5836eddce8db') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
    }

    header {
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      padding: 20px;
      color: #fff;
      background-color: rgba(0,0,0,0.6);
    }

    #entryForm {
      background: #fdf5e6;
      border: 2px dashed #ccc;
      padding: 15px;
      margin: 10px auto;
      max-width: 800px;
      border-radius: 8px;
      display: none;
    }

    #bottleGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      padding: 20px;
    }

    .bottle {
      background: rgba(255,255,255,0.9);
      border-left: 5px solid #c19a6b;
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }

    .bottle.rare {
      border-left: 5px solid gold;
    }

    .bottle.killed {
      opacity: 0.6;
      background: #eee;
    }

    .actions {
      position: absolute;
      top: 8px;
      right: 10px;
      display: flex;
      gap: 5px;
    }

    .actions button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
    }

    .filters {
      max-width: 800px;
      margin: 10px auto;
      padding: 10px;
      background: #fff8dc;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .filters select {
      padding: 5px;
    }

    .toggleForm {
      margin: 10px auto;
      text-align: center;
    }

    .toggleForm button {
      padding: 8px 14px;
      font-size: 16px;
      background: #a67c52;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .return-btn {
      position: fixed;
      bottom: 15px;
      right: 15px;
      padding: 10px 15px;
      background: #333;
      color: white;
      text-decoration: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>The Tipsy Bunghole: Bottles</header>

  <div class="toggleForm">
    <button onclick="toggleForm()">Add a Bottle</button>
  </div>

  <form id="entryForm">
    <input type="text" id="name" placeholder="Bottle Name" required />
    <input type="text" id="distillery" placeholder="Distillery" />
    <input type="number" id="year" placeholder="Year" />
    <input type="text" id="proof" placeholder="Proof" />
    <button type="submit">Add Bottle</button>
  </form>

  <div class="filters">
    <select id="distilleryFilter">
      <option value="">Filter by Distillery</option>
    </select>
    <select id="favoriteFilter">
      <option value="">Favorites</option>
      <option value="true">Only Favorites</option>
    </select>
    <select id="killedFilter">
      <option value="">Killed?</option>
      <option value="true">Only Killed</option>
      <option value="false">Only Alive</option>
    </select>
    <button onclick="clearFilters()">Clear Filters</button>
  </div>

  <div id="bottleGrid"></div>

  <a href="index.html" class="return-btn">Return to Bunghole</a>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
      authDomain: "tipsy-bunghole-photos.firebaseapp.com",
      projectId: "tipsy-bunghole-photos",
      storageBucket: "tipsy-bunghole-photos.appspot.com",
      messagingSenderId: "223660009700",
      appId: "1:223660009700:web:YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const bottleGrid = document.getElementById("bottleGrid");
    const form = document.getElementById("entryForm");
    const distilleryFilter = document.getElementById("distilleryFilter");
    const favoriteFilter = document.getElementById("favoriteFilter");
    const killedFilter = document.getElementById("killedFilter");

    const isAdmin = localStorage.getItem("bungholeRole") === "admin";

    function toggleForm() {
      form.style.display = form.style.display === "none" ? "block" : "none";
    }

    function clearFilters() {
      distilleryFilter.value = "";
      favoriteFilter.value = "";
      killedFilter.value = "";
      fetchBottles();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const newBottle = {
        name: form.name.value,
        distillery: form.distillery.value,
        year: form.year.value,
        proof: form.proof.value,
        killed: false,
        favorite: false,
        rare: false,
        timestamp: Date.now()
      };
      await db.collection("bottles").add(newBottle);
      form.reset();
      toggleForm();
      fetchBottles();
    });

    function renderBottle(doc, id) {
      const data = doc.data();
      const bottle = document.createElement("div");
      bottle.className = "bottle" + (data.killed ? " killed" : "") + (data.rare ? " rare" : "");
      bottle.innerHTML = `
        <strong>${data.name}</strong><br>
        ${data.distillery || ''}<br>
        ${data.year || ''} | ${data.proof || ''}<br>
        <label><input type="checkbox" ${data.killed ? 'checked' : ''} onchange="toggleKilled('${doc.id}', this)"> Killed</label>
        <label><input type="checkbox" ${data.favorite ? 'checked' : ''} onchange="toggleFavorite('${doc.id}', this)"> ‚ù§Ô∏è</label>
        <label><input type="checkbox" ${data.rare ? 'checked' : ''} onchange="toggleRare('${doc.id}', this)"> ü¶Ñ</label>
      `;

      if (isAdmin) {
        const actions = document.createElement("div");
        actions.className = "actions";
        actions.innerHTML = `
          <button onclick="editBottle('${doc.id}')">‚úèÔ∏è</button>
          <button onclick="deleteBottle('${doc.id}')">üóëÔ∏è</button>
        `;
        bottle.appendChild(actions);
      }

      bottleGrid.appendChild(bottle);
    }

    function toggleKilled(id, checkbox) {
      db.collection("bottles").doc(id).update({ killed: checkbox.checked });
    }

    function toggleFavorite(id, checkbox) {
      db.collection("bottles").doc(id).update({ favorite: checkbox.checked });
    }

    function toggleRare(id, checkbox) {
      db.collection("bottles").doc(id).update({ rare: checkbox.checked });
    }

    function deleteBottle(id) {
      if (confirm("Delete this bottle?")) {
        db.collection("bottles").doc(id).delete();
        fetchBottles();
      }
    }

    function editBottle(id) {
      const name = prompt("Enter new name:");
      if (name) {
        db.collection("bottles").doc(id).update({ name });
        fetchBottles();
      }
    }

    async function fetchBottles() {
      bottleGrid.innerHTML = "";
      const snapshot = await db.collection("bottles").orderBy("timestamp").get();
      const distilleries = new Set();

      snapshot.docs.forEach(doc => {
        const data = doc.data();
        distilleries.add(data.distillery);

        if (
          (distilleryFilter.value && data.distillery !== distilleryFilter.value) ||
          (favoriteFilter.value === "true" && !data.favorite) ||
          (killedFilter.value === "true" && !data.killed) ||
          (killedFilter.value === "false" && data.killed)
        ) {
          return;
        }

        renderBottle(doc, doc.id);
      });

      distilleryFilter.innerHTML = `<option value="">Filter by Distillery</option>`;
      distilleries.forEach(d => {
        if (d) {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          distilleryFilter.appendChild(opt);
        }
      });
    }

    distilleryFilter.addEventListener("change", fetchBottles);
    favoriteFilter.addEventListener("change", fetchBottles);
    killedFilter.addEventListener("change", fetchBottles);

    fetchBottles();
  </script>
</body>
</html>
