<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Tipsy Bunghole Bottles</title>
  <style>
    body {
      background-image: url('https://firebasestorage.googleapis.com/v0/b/tipsy-bunghole-photos.appspot.com/o/IMG_0037.jpeg?alt=media&token=857fc39c-1247-45df-9fc7-5836eddce8db');
      background-size: cover;
      font-family: 'Courier New', monospace;
      color: #fff;
      padding: 20px;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #000
    }

    #bottleForm {
      background: rgba(255, 255, 255, 0.1);
      border: 2px dashed #ffb347;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 10px;
    }

    .filter-container {
      margin-bottom: 20px;
    }

    .filter-container input,
    .filter-container select {
      margin-right: 10px;
      padding: 5px;
    }

    .bottle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fffef0;
      color: #000;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      font-family: 'Courier New', monospace;
      position: relative;
    }

    .bottle-row.killed {
      opacity: 0.4;
      text-decoration: line-through;
    }

    .bottle-info {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      flex: 1;
      min-width: 0;
      overflow-wrap: break-word;
    }

    .bottle-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .favorite-toggle {
      font-size: 1.5em;
      cursor: pointer;
      color: gold;
      user-select: none;
    }

    .favorite-toggle.inactive {
      color: #ccc;
    }

    .toggle-switch {
      cursor: pointer;
      user-select: none;
    }

    .edit-icon {
      margin-left: 10px;
      cursor: pointer;
      font-size: 1.2em;
      user-select: none;
    }

    .drag-handle {
      cursor: grab;
      margin-right: 10px;
      user-select: none;
    }

    button {
      background-color: #ffb347;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
    }

    input.edit-name,
    input.edit-distillery,
    input.edit-proof,
    input.edit-shelf {
      font-family: 'Courier New', monospace;
      font-size: 1em;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: auto;
      min-width: 60px;
    }
  </style>
</head>
<body>

  <h1>üì¶ The Tipsy Bunghole Bottle Inventory</h1>

  <div class="filter-container">
    <input type="text" id="searchBar" placeholder="Search..." />
    <select id="filterDistillery">
      <option value="">All Distilleries</option>
    </select>
    <select id="filterFavorite">
      <option value="">All</option>
      <option value="true">Favorites</option>
      <option value="false">Non-Favorites</option>
    </select>
    <select id="filterKilled">
      <option value="">All</option>
      <option value="true">Killed</option>
      <option value="false">Alive</option>
    </select>
    <select id="filterShelf">
      <option value="">All Shelves</option>
    </select>
  </div>

  <div id="bottleForm">
    <input type="text" id="nameInput" placeholder="Bottle Name">
    <input type="text" id="distilleryInput" placeholder="Distillery">
    <input type="text" id="proofInput" placeholder="Proof">
    <input type="text" id="shelfInput" placeholder="Shelf#">
    <button onclick="addBottle()">Add Bottle</button>
  </div>

  <div id="bottleList"></div>

  <!-- Firebase & Sortable -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
      authDomain: "tipsy-bunghole-photos.firebaseapp.com",
      projectId: "tipsy-bunghole-photos",
      storageBucket: "tipsy-bunghole-photos.appspot.com",
      messagingSenderId: "183586489596",
      appId: "1:183586489596:web:3f7dd0d0f9ae30c9e059f2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const bottleList = document.getElementById('bottleList');
    const distilleryFilter = document.getElementById('filterDistillery');
    const favoriteFilter = document.getElementById('filterFavorite');
    const killedFilter = document.getElementById('filterKilled');
    const shelfFilter = document.getElementById('filterShelf');
    const searchBar = document.getElementById('searchBar');

    function renderBottle(doc) {
      const data = doc.data();
      const div = document.createElement('div');
      div.className = 'bottle-row';
      if (data.killed) div.classList.add('killed');
      div.setAttribute('data-id', doc.id);
      div.setAttribute('data-name', (data.name || '').toLowerCase());
      div.setAttribute('data-distillery', (data.distillery || '').toLowerCase());
      div.setAttribute('data-favorite', data.favorite || false);
      div.setAttribute('data-killed', data.killed || false);
      div.setAttribute('data-shelf', (data.shelf || '').toLowerCase());
      
      div.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <div class="bottle-info">
          <span>${data.name}</span>
          <span>${data.distillery}</span>
          <span>${data.proof}</span>
          <span>Shelf: ${data.shelf || 'N/A'}</span>
        </div>
        <div class="bottle-controls">
          <span class="favorite-toggle ${data.favorite ? '' : 'inactive'}" onclick="toggleFavorite('${doc.id}', this)">‚òÖ</span>
          <label class="toggle-switch">
            <input type="checkbox" onchange="toggleKilled('${doc.id}', this.checked)" ${data.killed ? 'checked' : ''}>
            ü™¶
          </label>
          <span class="edit-icon" onclick="editBottle('${doc.id}')">‚úèÔ∏è</span>
        </div>
      `;
      bottleList.appendChild(div);
    }

    function fetchAndRender() {
      bottleList.innerHTML = '';
      const distillerySet = new Set();
      const shelfSet = new Set();

      db.collection('bottles').orderBy('order').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.distillery) distillerySet.add(data.distillery);
          if (data.shelf) shelfSet.add(data.shelf);
          renderBottle(doc);
        });
        populateFilters(distillerySet, shelfSet);
        applyFilters();
      });
    }

    function populateFilters(distilleries, shelves) {
      distilleryFilter.innerHTML = `<option value="">All Distilleries</option>`;
      Array.from(distilleries).sort().forEach(d => {
        distilleryFilter.innerHTML += `<option value="${d}">${d}</option>`;
      });

      shelfFilter.innerHTML = `<option value="">All Shelves</option>`;
      Array.from(shelves).sort().forEach(s => {
        shelfFilter.innerHTML += `<option value="${s}">${s}</option>`;
      });
    }

    function addBottle() {
      const name = document.getElementById('nameInput').value.trim();
      const distillery = document.getElementById('distilleryInput').value.trim();
      const proof = document.getElementById('proofInput').value.trim();
      const shelf = document.getElementById('shelfInput').value.trim();

      if (!name || !distillery) return;

      db.collection('bottles').add({
        name, distillery, proof, shelf,
        killed: false,
        favorite: false,
        order: Date.now()
      }).then(() => {
        document.getElementById('nameInput').value = '';
        document.getElementById('distilleryInput').value = '';
        document.getElementById('proofInput').value = '';
        document.getElementById('shelfInput').value = '';
        fetchAndRender();
      });
    }

    function toggleKilled(id, state) {
      db.collection('bottles').doc(id).update({ killed: state }).then(fetchAndRender);
    }

    function toggleFavorite(id, el) {
      const isActive = !el.classList.contains('inactive');
      db.collection('bottles').doc(id).update({ favorite: !isActive }).then(() => {
        el.classList.toggle('inactive', isActive);
        el.parentElement.parentElement.setAttribute('data-favorite', String(!isActive));
        applyFilters();
      });
    }

    function editBottle(id) {
      const row = bottleList.querySelector(`[data-id="${id}"]`);
      if (!row) return;

      // Prevent multiple edits
      if (row.classList.contains('editing')) return;

      row.classList.add('editing');

      // Grab current data from row elements
      const data = {
        name: row.querySelector('.bottle-info > span:nth-child(1)').textContent,
        distillery: row.querySelector('.bottle-info > span:nth-child(2)').textContent,
        proof: row.querySelector('.bottle-info > span:nth-child(3)').textContent,
        shelf: row.querySelector('.bottle-info > span:nth-child(4)').textContent.replace('Shelf: ', ''),
      };

      // Replace info display with inputs
      row.querySelector('.bottle-info').innerHTML = `
        <input type="text" class="edit-name" value="${data.name}" style="width: 120px; margin-right: 5px;">
        <input type="text" class="edit-distillery" value="${data.distillery}" style="width: 120px; margin-right: 5px;">
        <input type="text" class="edit-proof" value="${data.proof}" style="width: 60px; margin-right: 5px;">
        <input type="text" class="edit-shelf" value="${data.shelf}" style="width: 60px;">
      `;

      // Replace controls with Save and Cancel buttons
      const controls = row.querySelector('.bottle-controls');
      controls.innerHTML = `
        <button class="save-btn">üíæ Save</button>
        <button class="cancel-btn">‚ùå Cancel</button>
      `;

      controls.querySelector('.save-btn').onclick = () => saveEdit(id);
      controls.querySelector('.cancel-btn').onclick = () => cancelEdit(id);
    }

    function saveEdit(id) {
      const row = bottleList.querySelector(`[data-id="${id}"]`);
      if (!row) return;

      // Get values from inputs
      const name = row.querySelector('.edit-name').value.trim();
      const distillery = row.querySelector('.edit-distillery').value.trim();
      const proof = row.querySelector('.edit-proof').value.trim();
      const shelf = row.querySelector('.edit-shelf').value.trim();

      if (!name || !distillery) {
        alert('Name and Distillery cannot be empty!');
        return;
      }

      // Update Firestore
      db.collection('bottles').doc(id).update({
        name,
        distillery,
        proof,
        shelf
      }).then(() => {
        row.classList.remove('editing');
        // Re-render updated bottle row info
        row.querySelector('.bottle-info').innerHTML = `
          <span>${name}</span>
          <span>${distillery}</span>
          <span>${proof}</span>
          <span>Shelf: ${shelf || 'N/A'}</span>
        `;

        // Restore bottle controls (favorite star, killed toggle, edit icon)
        const dataFavorite = row.getAttribute('data-favorite') === 'true';
        const dataKilled = row.getAttribute('data-killed') === 'true';

        row.querySelector('.bottle-controls').innerHTML = `
          <span class="favorite-toggle ${dataFavorite ? '' : 'inactive'}" onclick="toggleFavorite('${id}', this)">‚òÖ</span>
          <label class="toggle-switch">
            <input type="checkbox" onchange="toggleKilled('${id}', this.checked)" ${dataKilled ? 'checked' : ''}>
            ü™¶
          </label>
          <span class="edit-icon" onclick="editBottle('${id}')">‚úèÔ∏è</span>
        `;

        // Update data attributes for filtering
        row.setAttribute('data-name', name.toLowerCase());
        row.setAttribute('data-distillery', distillery.toLowerCase());
        row.setAttribute('data-shelf', shelf.toLowerCase());
      }).catch(err => {
        alert('Failed to save changes: ' + err.message);
      });
    }

    function cancelEdit(id) {
      const row = bottleList.querySelector(`[data-id="${id}"]`);
      if (!row) return;

      row.classList.remove('editing');

      // Get original data from Firestore again to restore
      db.collection('bottles').doc(id).get().then(doc => {
        if (!doc.exists) return;
        const data = doc.data();

        row.querySelector('.bottle-info').innerHTML = `
          <span>${data.name}</span>
          <span>${data.distillery}</span>
          <span>${data.proof}</span>
          <span>Shelf: ${data.shelf || 'N/A'}</span>
        `;

        row.querySelector('.bottle-controls').innerHTML = `
          <span class="favorite-toggle ${data.favorite ? '' : 'inactive'}" onclick="toggleFavorite('${id}', this)">‚òÖ</span>
          <label class="toggle-switch">
            <input type="checkbox" onchange="toggleKilled('${id}', this.checked)" ${data.killed ? 'checked' : ''}>
            ü™¶
          </label>
          <span class="edit-icon" onclick="editBottle('${id}')">‚úèÔ∏è</span>
        `;

        // Restore data attributes for filtering
        row.setAttribute('data-name', (data.name || '').toLowerCase());
        row.setAttribute('data-distillery', (data.distillery || '').toLowerCase());
        row.setAttribute('data-favorite', data.favorite || false);
        row.setAttribute('data-killed', data.killed || false);
        row.setAttribute('data-shelf', (data.shelf || '').toLowerCase());
      });
    }

    function applyFilters() {
      const searchText = searchBar.value.toLowerCase();
      const distilleryVal = distilleryFilter.value.toLowerCase();
      const favoriteVal = favoriteFilter.value;
      const killedVal = killedFilter.value;
      const shelfVal = shelfFilter.value.toLowerCase();

      Array.from(bottleList.children).forEach(row => {
        const name = row.getAttribute('data-name');
        const distillery = row.getAttribute('data-distillery');
        const favorite = row.getAttribute('data-favorite');
        const killed = row.getAttribute('data-killed');
        const shelf = row.getAttribute('data-shelf');

        const matchesSearch = name.includes(searchText) || distillery.includes(searchText);
        const matchesDistillery = !distilleryVal || distillery === distilleryVal;
        const matchesFavorite = favoriteVal === '' || favorite === favoriteVal;
        const matchesKilled = killedVal === '' || killed === killedVal;
        const matchesShelf = !shelfVal || shelf === shelfVal;

        if (matchesSearch && matchesDistillery && matchesFavorite && matchesKilled && matchesShelf) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    // Event Listeners for filters/search
    searchBar.addEventListener('input', applyFilters);
    distilleryFilter.addEventListener('change', applyFilters);
    favoriteFilter.addEventListener('change', applyFilters);
    killedFilter.addEventListener('change', applyFilters);
    shelfFilter.addEventListener('change', applyFilters);

    // Initialize Sortable
    new Sortable(bottleList, {
      handle: '.drag-handle',
      animation: 150,
      onEnd: function(evt) {
        Array.from(bottleList.children).forEach((child, index) => {
          const id = child.getAttribute('data-id');
          db.collection('bottles').doc(id).update({ order: index });
        });
      }
    });

    fetchAndRender();
  </script>
</body>
</html>
