<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Tipsy Bunghole Bottles</title>
  <style>
    body { font-family: Courier, monospace; margin: 1rem; }
    #errorMessage { white-space: pre-wrap; text-align: center; margin: 1rem 0; font-weight: bold; }
    .filters, .bottle-grid { margin-bottom: 1rem; }
    .bottle-card img { max-width:100%; max-height:150px; border-radius:6px; }
  </style>
</head>
<body>

<header>The Tipsy Bunghole Bottle Inventory</header>

<button onclick="window.location.href='index.html'">Return to Bunghole</button>

<div class="filters">
  <label>Filter:
    <select id="filterSelect">
      <option value="all">All</option>
      <option value="favorite">Favorites</option>
      <option value="rare">Rare</option>
      <option value="killed">Killed</option>
    </select>
  </label>
  <label>Sort by:
    <select id="sortSelect">
      <option value="name">Name</option>
      <option value="proof">Proof</option>
      <option value="age">Age</option>
    </select>
  </label>
</div>

<form id="bottleForm">
  <input id="name" placeholder="Bottle Name" required />
  <input id="distillery" placeholder="Distillery" />
  <input id="age" placeholder="Age" />
  <input id="proof" placeholder="Proof" />
  <input type="file" id="photo" accept="image/*" />
  <button type="submit">Add Bottle</button>
</form>

<div id="errorMessage">🟢 Ready to submit</div>

<div class="bottle-grid" id="bottleGrid"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
  authDomain: "tipsy-bunghole-photos.firebaseapp.com",
  projectId: "tipsy-bunghole-photos",
  storageBucket: "tipsy-bunghole-photos.appspot.com",
  messagingSenderId: "223660009700",
  appId: "1:223660009700:web:yourappid"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const bottlesRef = collection(db, "bottles");

const form = document.getElementById("bottleForm");
const errorBox = document.getElementById("errorMessage");
const filterSelect = document.getElementById("filterSelect");
const sortSelect = document.getElementById("sortSelect");
const bottleGrid = document.getElementById("bottleGrid");

let bottleData = [];

form.addEventListener("submit", async e => {
  e.preventDefault();
  errorBox.style.color = "black";
  errorBox.textContent = "🚀 Starting submission…";

  try {
    const name = form.name.value.trim();
    const distillery = form.distillery.value.trim();
    const age = form.age.value.trim();
    const proof = form.proof.value.trim();

    const file = document.getElementById("photo").files[0];
    let photoUrl = "";

    if (file) {
      errorBox.textContent = "🧪 Preparing photo…";
      const buffer = await file.arrayBuffer();
      const blob = new Blob([buffer], { type: file.type });

      errorBox.textContent = "📤 Uploading photo…";
      const storageRef = ref(storage, `bottles/${Date.now()}-${file.name}`);
      const uploadTask = uploadBytesResumable(storageRef, blob, { contentType: file.type });

      await new Promise((resolve, reject) => {
        const timer = setTimeout(() => reject(new Error("Upload timed out (30 s)")), 30000);
        uploadTask.on("state_changed", null,
          err => { clearTimeout(timer); reject(err); },
          () => { clearTimeout(timer); resolve(); }
        );
      });

      photoUrl = await getDownloadURL(uploadTask.snapshot.ref);
      errorBox.style.color = "green";
      errorBox.textContent = "✅ Photo uploaded.";
    } else {
      errorBox.textContent = "ℹ️ No photo selected.";
    }

    errorBox.textContent = "⏳ Saving bottle data…";
    await addDoc(bottlesRef, { name, distillery, age, proof, killed: false, favorite: false, rare: false, photoUrl });

    form.reset();
    errorBox.style.color = "green";
    errorBox.textContent = "✅ Bottle added successfully!";

  } catch (err) {
    console.error("Submission error:", err);
    errorBox.style.color = "red";
    errorBox.textContent = `🚨 Error: ${err.message || err}`;
  }
});

onSnapshot(bottlesRef, snapshot => {
  bottleData = snapshot.docs.map(d => ({ id: d.id, data: d.data() }));
  renderBottles();
});

filterSelect.addEventListener("change", renderBottles);
sortSelect.addEventListener("change", renderBottles);

function renderBottles() {
  bottleGrid.innerHTML = "";
  let list = [...bottleData];
  const filter = filterSelect.value;
  const sort = sortSelect.value;

  if (filter !== "all") list = list.filter(b => b.data[filter]);
  list.sort((a,b) => (a.data[sort]||"").localeCompare(b.data[sort]||"", undefined, { numeric: true }));

  list.forEach(({ id, data }) => {
    const card = document.createElement("div");
    card.className = "bottle-card";

    if (data.photoUrl) {
      const img = document.createElement("img");
      img.src = data.photoUrl;
      card.appendChild(img);
    }

    ["name","distillery","age","proof"].forEach(field => {
      const div = document.createElement("div");
      div.innerHTML = `<strong>${field.slice(0,1).toUpperCase()+field.slice(1)}:</strong> ${data[field]||"N/A"}`;
      card.appendChild(div);
    });

    bottleGrid.appendChild(card);
  });
}
</script>

</body>
</html>
