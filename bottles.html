<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Tipsy Bunghole Bottles</title>
  <style>
    body {
      background-image: url('https://firebasestorage.googleapis.com/v0/b/tipsy-bunghole-photos.appspot.com/o/IMG_0037.jpeg?alt=media&token=857fc39c-1247-45df-9fc7-5836eddce8db');
      background-size: cover;
      font-family: 'Courier New', monospace;
      color: #fff;
      padding: 20px;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 20px;
    }

    #bottleForm {
      background: rgba(255, 255, 255, 0.1);
      border: 2px dashed #ffb347;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 10px;
    }

    .filter-container {
      margin-bottom: 20px;
    }

    .filter-container input,
    .filter-container select {
      margin-right: 10px;
      padding: 5px;
    }

    .bottle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fffef0;
      color: #000;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      font-family: 'Courier New', monospace;
    }

    .bottle-row.killed {
      opacity: 0.4;
      text-decoration: line-through;
    }

    .bottle-info {
      display: flex;
      gap: 20px;
      flex: 1;
      flex-wrap: wrap;
    }

    .drag-handle {
      cursor: grab;
      margin-right: 10px;
    }

    .favorite-toggle {
      cursor: pointer;
      color: gold;
    }

    .favorite-toggle.inactive {
      color: #ccc;
    }

    .toggle-switch {
      cursor: pointer;
    }

    .edit-icon {
      margin-left: 10px;
      cursor: pointer;
      font-size: 14px;
    }

    button {
      background-color: #ffb347;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>üì¶ The Tipsy Bunghole Bottle Inventory</h1>

  <div class="filter-container">
    <input type="text" id="searchBar" placeholder="Search..." />
    <select id="filterDistillery">
      <option value="">All Distilleries</option>
    </select>
    <select id="filterFavorite">
      <option value="">All</option>
      <option value="true">Favorites</option>
      <option value="false">Non-Favorites</option>
    </select>
    <select id="filterKilled">
      <option value="">All</option>
      <option value="true">Killed</option>
      <option value="false">Alive</option>
    </select>
    <select id="filterShelf">
      <option value="">All Shelves</option>
    </select>
  </div>

  <div id="bottleForm">
    <input type="text" id="nameInput" placeholder="Bottle Name" />
    <input type="text" id="distilleryInput" placeholder="Distillery" />
    <input type="text" id="proofInput" placeholder="Proof" />
    <input type="text" id="shelfInput" placeholder="Shelf#" />
    <button onclick="addBottle()">Add Bottle</button>
  </div>

  <div id="bottleList"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <script>
    // Firebase config and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
      authDomain: "tipsy-bunghole-photos.firebaseapp.com",
      projectId: "tipsy-bunghole-photos",
      storageBucket: "tipsy-bunghole-photos.appspot.com",
      messagingSenderId: "183586489596",
      appId: "1:183586489596:web:3f7dd0d0f9ae30c9e059f2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM elements
    const bottleList = document.getElementById('bottleList');
    const distilleryFilter = document.getElementById('filterDistillery');
    const favoriteFilter = document.getElementById('filterFavorite');
    const killedFilter = document.getElementById('filterKilled');
    const shelfFilter = document.getElementById('filterShelf');
    const searchBar = document.getElementById('searchBar');

    // Render a bottle row
    function renderBottle(doc) {
      const data = doc.data();
      const div = document.createElement('div');
      div.className = 'bottle-row';
      if (data.killed) div.classList.add('killed');

      div.setAttribute('data-id', doc.id);
      div.setAttribute('data-name', data.name.toLowerCase());
      div.setAttribute('data-distillery', data.distillery.toLowerCase());
      div.setAttribute('data-favorite', data.favorite ? 'true' : 'false');
      div.setAttribute('data-killed', data.killed ? 'true' : 'false');
      // Handle shelf - if missing, store 'unknown'
      const shelfVal = data.shelf ? data.shelf.toString().toLowerCase() : 'unknown';
      div.setAttribute('data-shelf', shelfVal);

      div.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <div class="bottle-info">
          <span>${data.name}</span>
          <span>${data.distillery}</span>
          <span>${data.proof || ''}</span>
          <span>Shelf: ${data.shelf || 'Unknown'}</span>
        </div>
        <span class="favorite-toggle ${data.favorite ? '' : 'inactive'}" onclick="toggleFavorite('${doc.id}', ${!data.favorite})">‚òÖ</span>
        <label class="toggle-switch">
          <input type="checkbox" onchange="toggleKilled('${doc.id}', this.checked)" ${data.killed ? 'checked' : ''} />
          ü™¶
        </label>
        <span class="edit-icon" onclick="editBottle('${doc.id}')">‚úèÔ∏è</span>
      `;
      bottleList.appendChild(div);
    }

    // Fetch bottles and render list + filters
    function fetchAndRender() {
      bottleList.innerHTML = '';
      const distillerySet = new Set();
      const shelfSet = new Set();

      db.collection('bottles').orderBy('order').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          distillerySet.add(data.distillery);
          if (data.shelf) {
            shelfSet.add(data.shelf);
          } else {
            shelfSet.add('Unknown');
          }
          renderBottle(doc);
        });
        populateFilter(distillerySet, shelfSet);
        applyFilters();
      });
    }

    // Populate filter dropdowns for distillery and shelf
    function populateFilter(distilleries, shelves) {
      // Distillery filter
      distilleryFilter.innerHTML = `<option value="">All Distilleries</option>`;
      Array.from(distilleries).sort().forEach(d => {
        distilleryFilter.innerHTML += `<option value="${d}">${d}</option>`;
      });

      // Shelf filter
      shelfFilter.innerHTML = `<option value="">All Shelves</option>`;
      Array.from(shelves).sort().forEach(s => {
        shelfFilter.innerHTML += `<option value="${s.toLowerCase()}">${s}</option>`;
      });
    }

    // Add a new bottle to Firestore
    function addBottle() {
      const name = document.getElementById('nameInput').value.trim();
      const distillery = document.getElementById('distilleryInput').value.trim();
      const proof = document.getElementById('proofInput').value.trim();
      const shelf = document.getElementById('shelfInput').value.trim();

      if (!name || !distillery) return;

      db.collection('bottles').add({
        name,
        distillery,
        proof,
        shelf: shelf || null,
        killed: false,
        favorite: false,
        order: Date.now()
      }).then(() => {
        // Clear inputs after adding
        document.getElementById('nameInput').value = '';
        document.getElementById('distilleryInput').value = '';
        document.getElementById('proofInput').value = '';
        document.getElementById('shelfInput').value = '';
        fetchAndRender();
      }).catch(err => {
        console.error("Error adding bottle:", err);
      });
    }

    // Toggle killed state
    function toggleKilled(id, state) {
      db.collection('bottles').doc(id).update({ killed: state }).catch(console.error);
    }

    // Toggle favorite state
    function toggleFavorite(id, state) {
      db.collection('bottles').doc(id).update({ favorite: state }).catch(console.error);
    }

    // Edit bottle stub
    function editBottle(id) {
      alert("Editing not yet implemented.");
    }

    // Enable drag & drop sorting
    new Sortable(bottleList, {
      handle: '.drag-handle',
      animation: 150,
      onEnd: function () {
        const newOrder = [...bottleList.children].map((el, index) => ({
          id: el.dataset.id,
          order: index
        }));
        newOrder.forEach(item => {
          db.collection('bottles').doc(item.id).update({ order: item.order }).catch(console.error);
        });
      }
    });

    // Apply filters on input changes
    [searchBar, distilleryFilter, favoriteFilter, killedFilter, shelfFilter].forEach(el => {
      el.addEventListener('input', applyFilters);
    });

    // Filter visible bottles based on inputs
    function applyFilters() {
      const search = searchBar.value.toLowerCase();
      const dist = distilleryFilter.value.toLowerCase();
      const fav = favoriteFilter.value;
      const kill = killedFilter.value;
      const shelf = shelfFilter.value.toLowerCase();

      [...bottleList.children].forEach(row => {
        const name = row.dataset.name;
        const distillery = row.dataset.distillery;
        const favorite = row.dataset.favorite === 'true';
        const killed = row.dataset.killed === 'true';
        const shelfNum = row.dataset.shelf || 'unknown';

        let show = true;
        if (search && !name.includes(search) && !distillery.includes(search)) show = false;
        if (dist && distillery !== dist) show = false;
        if (fav && String(favorite) !== fav) show = false;
        if (kill && String(killed) !== kill) show = false;
        if (shelf && shelfNum !== shelf) show = false;

        row.style.display = show ? 'flex' : 'none';
      });
    }

    // Initial fetch and render on page load
    fetchAndRender();

  </script>
</body>
</html>
