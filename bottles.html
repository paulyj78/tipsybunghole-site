<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Tipsy Bunghole â€“ Bottles</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #f9f5e3;
      margin: 0;
      padding: 0;
    }

    .entry-form {
      background: #fff8dc;
      padding: 15px;
      margin: 20px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      box-shadow: 3px 3px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .form-toggle {
      cursor: pointer;
      background-color: #deb887;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      text-align: left;
    }

    .bottle-entry {
      background: #fff;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      position: relative;
      cursor: grab;
      transition: transform 0.2s ease;
      font-size: 14px;
    }

    .bottle-entry.dragging {
      opacity: 0.5;
    }

    .ripped {
      background: #fff;
      border: 1px solid #ccc;
      clip-path: polygon(0% 0%, 100% 0%, 100% 95%, 95% 100%, 5% 100%, 0% 95%);
    }

    .edit-icon {
      width: 16px;
      cursor: pointer;
    }

    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .return-btn {
      display: block;
      margin: 40px auto;
      padding: 12px 24px;
      background: #8b0000;
      color: white;
      font-size: 16px;
      text-align: center;
      border-radius: 8px;
      text-decoration: none;
      width: fit-content;
    }
  </style>
</head>
<body>

<button class="form-toggle" onclick="toggleForm()">Add a New Bottle</button>

<div id="form-container" class="entry-form" style="display:none;">
  <input id="bottleName" placeholder="Bottle Name" /><br/>
  <input id="distillery" placeholder="Distillery" /><br/>
  <input id="proof" placeholder="Proof" /><br/>
  <input id="notes" placeholder="Notes" /><br/>
  <label><input type="checkbox" id="isRare" /> Mark as Rare</label><br/>
  <button onclick="addBottle()">Add Bottle</button>
</div>

<div id="bottleList"></div>

<a href="index.html" class="return-btn">Return to the Bunghole</a>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
    authDomain: "tipsy-bunghole-guest-book.firebaseapp.com",
    projectId: "tipsy-bunghole-photos",
    storageBucket: "tipsy-bunghole-photos.appspot.com",
    messagingSenderId: "152050189848",
    appId: "1:152050189848:web:9ba719e8d2ad24c138e56d",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const bottlesRef = collection(db, "bottles");

  function toggleForm() {
    const form = document.getElementById("form-container");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  async function addBottle() {
    const name = document.getElementById("bottleName").value;
    const distillery = document.getElementById("distillery").value;
    const proof = document.getElementById("proof").value;
    const notes = document.getElementById("notes").value;
    const isRare = document.getElementById("isRare").checked;

    if (!name) return;

    await addDoc(bottlesRef, {
      name,
      distillery,
      proof,
      notes,
      isRare,
      killed: false,
      order: Date.now(),
    });

    loadBottles();
    document.getElementById("form-container").style.display = "none";
  }

  async function loadBottles() {
    const querySnapshot = await getDocs(bottlesRef);
    const list = document.getElementById("bottleList");
    list.innerHTML = "";

    const entries = [];
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      entries.push({ id: docSnap.id, ...data });
    });

    entries.sort((a, b) => a.order - b.order);

    entries.forEach(entry => {
      const row = document.createElement("div");
      row.className = "bottle-entry ripped";
      row.setAttribute("draggable", "true");
      row.innerHTML = `
        <strong>${entry.name}</strong> (${entry.distillery}) â€“ ${entry.proof} proof<br/>
        <em>${entry.notes || ""}</em><br/>
        ${entry.isRare ? "ðŸ¦„ <strong>Rare</strong><br/>" : ""}
        <label><input type="checkbox" ${entry.killed ? "checked" : ""} onchange="toggleKilled('${entry.id}', this.checked)"> Killed</label>
        <img src="https://cdn-icons-png.flaticon.com/512/84/84380.png" class="edit-icon" onclick="editBottle('${entry.id}')" />
      `;
      row.dataset.id = entry.id;
      list.appendChild(row);
    });

    enableDragAndDrop();
  }

  window.toggleKilled = async (id, killed) => {
    const bottleDoc = doc(db, "bottles", id);
    await updateDoc(bottleDoc, { killed });
    loadBottles();
  };

  window.editBottle = async (id) => {
    const bottleDoc = doc(db, "bottles", id);
    const docSnap = await getDocs(bottlesRef);
    const data = (await getDocs(bottlesRef)).docs.find(d => d.id === id).data();

    document.getElementById("bottleName").value = data.name;
    document.getElementById("distillery").value = data.distillery;
    document.getElementById("proof").value = data.proof;
    document.getElementById("notes").value = data.notes;
    document.getElementById("isRare").checked = data.isRare;
    document.getElementById("form-container").style.display = "block";

    await deleteDoc(bottleDoc);
  };

  function enableDragAndDrop() {
    let dragged;

    document.querySelectorAll(".bottle-entry").forEach(el => {
      el.addEventListener("dragstart", (e) => {
        dragged = el;
        e.dataTransfer.effectAllowed = "move";
      });

      el.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      el.addEventListener("drop", async (e) => {
        e.preventDefault();
        const parent = el.parentNode;
        const children = Array.from(parent.children);
        const draggedIndex = children.indexOf(dragged);
        const targetIndex = children.indexOf(el);
        if (draggedIndex < targetIndex) {
          parent.insertBefore(dragged, el.nextSibling);
        } else {
          parent.insertBefore(dragged, el);
        }

        // Recalculate order
        const reordered = Array.from(parent.children);
        for (let i = 0; i < reordered.length; i++) {
          const docId = reordered[i].dataset.id;
          await updateDoc(doc(db, "bottles", docId), { order: i });
        }
      });
    });
  }

  loadBottles();
</script>

</body>
</html>
