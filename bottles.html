<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Tipsy Bunghole - Bottles</title>
  <style>
    body {
      background-image: url('https://firebasestorage.googleapis.com/v0/b/tipsy-bunghole-photos.appspot.com/o/IMG_0037.jpeg?alt=media&token=857fc39c-1247-45df-9fc7-5836eddce8db');
      background-size: cover;
      background-position: center;
      font-family: 'Courier New', Courier, monospace;
      margin: 0;
      padding: 20px;
      color: #fff;
    }
    h1 {
      text-align: center;
    }

    #entry-form {
      background-color: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .form-row input {
      margin: 5px;
      padding: 6px;
    }

    #bottle-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .bottle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fdf6e3;
      color: #000;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9em;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      border: 2px dashed #c2a77b;
      position: relative;
    }

    .bottle-row.killed {
      background-color: #444;
      color: #999;
      text-decoration: line-through;
    }

    .edit-icon {
      cursor: pointer;
      margin-left: 10px;
    }

    .drag-handle {
      cursor: grab;
      margin-right: 10px;
    }

    .favorite {
      cursor: pointer;
      font-size: 1.2em;
      margin-left: 10px;
    }

    .favorite.active {
      color: gold;
    }

    button {
      padding: 6px 12px;
      background: #8b4513;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }

    input[type="text"] {
      padding: 6px;
      width: 140px;
    }

    .collapsed {
      display: none;
    }
  </style>
</head>
<body>
  <h1>üì¶ Bunghole Bottles</h1>

  <button onclick="toggleForm()">‚ûï Add Bottle</button>
  <div id="entry-form" class="collapsed">
    <div class="form-row">
      <input type="text" id="distillery" placeholder="Distillery" />
      <input type="text" id="name" placeholder="Name" />
      <input type="text" id="proof" placeholder="Proof" />
      <input type="text" id="notes" placeholder="Notes" />
      <button onclick="addBottle()">üíæ Save</button>
    </div>
  </div>

  <div id="bottle-list"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
      authDomain: "tipsy-bunghole-photos.firebaseapp.com",
      projectId: "tipsy-bunghole-photos",
      storageBucket: "tipsy-bunghole-photos.appspot.com",
      messagingSenderId: "783804314086",
      appId: "1:783804314086:web:9271f66c65c22bd3d2b4e2"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const bottleList = document.getElementById("bottle-list");

    function toggleForm() {
      document.getElementById("entry-form").classList.toggle("collapsed");
    }

    async function addBottle() {
      const distillery = document.getElementById("distillery").value.trim();
      const name = document.getElementById("name").value.trim();
      const proof = document.getElementById("proof").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (!distillery || !name) return;

      const docRef = await db.collection("bottles").add({
        distillery,
        name,
        proof,
        notes,
        killed: false,
        favorite: false,
        order: Date.now()
      });

      document.getElementById("distillery").value = "";
      document.getElementById("name").value = "";
      document.getElementById("proof").value = "";
      document.getElementById("notes").value = "";

      loadBottles();
    }

    async function loadBottles() {
      bottleList.innerHTML = "";
      const snapshot = await db.collection("bottles").orderBy("order").get();
      snapshot.forEach(doc => renderBottle(doc));
    }

    function renderBottle(doc) {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = `bottle-row${data.killed ? " killed" : ""}`;
      div.setAttribute("data-id", doc.id);

      div.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <span contenteditable="false" class="cell distillery">${data.distillery}</span>
        <span contenteditable="false" class="cell name">${data.name}</span>
        <span contenteditable="false" class="cell proof">${data.proof}</span>
        <span contenteditable="false" class="cell notes">${data.notes}</span>
        <button onclick="toggleKilled('${doc.id}', ${!data.killed})">üíÄ</button>
        <span class="favorite ${data.favorite ? 'active' : ''}" onclick="toggleFavorite('${doc.id}', ${!data.favorite})">‚òÖ</span>
        <span class="edit-icon" onclick="enableEdit(this)">‚úèÔ∏è</span>
      `;

      bottleList.appendChild(div);
    }

    async function toggleKilled(id, value) {
      await db.collection("bottles").doc(id).update({ killed: value });
      loadBottles();
    }

    async function toggleFavorite(id, value) {
      await db.collection("bottles").doc(id).update({ favorite: value });
      loadBottles();
    }

    function enableEdit(icon) {
      const row = icon.closest(".bottle-row");
      row.querySelectorAll(".cell").forEach(cell => {
        cell.contentEditable = true;
        cell.style.borderBottom = "1px dotted #444";
        cell.addEventListener("blur", () => saveEdits(row));
        cell.addEventListener("keypress", e => {
          if (e.key === "Enter") {
            e.preventDefault();
            cell.blur();
          }
        });
      });
    }

    async function saveEdits(row) {
      const id = row.getAttribute("data-id");
      const distillery = row.querySelector(".distillery").textContent.trim();
      const name = row.querySelector(".name").textContent.trim();
      const proof = row.querySelector(".proof").textContent.trim();
      const notes = row.querySelector(".notes").textContent.trim();

      await db.collection("bottles").doc(id).update({ distillery, name, proof, notes });

      row.querySelectorAll(".cell").forEach(cell => {
        cell.contentEditable = false;
        cell.style.borderBottom = "none";
      });
    }

    new Sortable(bottleList, {
      handle: ".drag-handle",
      animation: 150,
      onEnd: async () => {
        const ids = [...bottleList.children].map((el, index) => ({
          id: el.getAttribute("data-id"),
          order: index
        }));
        const batch = db.batch();
        ids.forEach(entry => {
          const ref = db.collection("bottles").doc(entry.id);
          batch.update(ref, { order: entry.order });
        });
        await batch.commit();
      }
    });

    loadBottles();
  </script>
</body>
</html>
