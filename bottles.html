<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Tipsy Bunghole Bottles</title>
  <style>
    body {
      font-family: "Courier New", monospace;
      background-image: url('https://firebasestorage.googleapis.com/v0/b/tipsy-bunghole-photos.appspot.com/o/IMG_0037.jpeg?alt=media&token=857fc39c-1247-45df-9fc7-5836eddce8db);
      background-size: cover;
      background-repeat: no-repeat;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .return-button {
      display: block;
      margin: 1rem auto;
      padding: 10px 20px;
      background-color: #a6794a;
      color: white;
      border: none;
      cursor: pointer;
    }

    .collapsible {
      background-color: #a6794a;
      color: white;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 1.1em;
    }

    .collapsible:hover {
      background-color: #8b6434;
    }

    .content {
      display: none;
      background-color: #fff8e6;
      padding: 10px;
      border: 1px solid #ccc;
    }

    form input {
      margin: 5px;
    }

    .controls {
      padding: 10px;
      background-color: rgba(255,255,255,0.9);
      text-align: center;
    }

    .controls label, .controls select {
      margin: 0 10px;
    }

    .bottle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      padding: 1rem;
    }

    .bottle-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      position: relative;
    }

    .toggle-group {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .edit-btn, .delete-btn {
      position: absolute;
      top: 5px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.1em;
    }

    .edit-btn { right: 30px; }
    .delete-btn { right: 5px; color: red; }
  </style>
</head>
<body>

<header>The Tipsy Bunghole Bottle Inventory</header>

<button onclick="window.location.href='index.html'" class="return-button">Return to Bunghole</button>

<button class="collapsible">➕ Add a Bottle</button>
<div class="content">
  <form id="bottleForm">
    <input type="text" id="name" placeholder="Bottle Name" required />
    <input type="text" id="distillery" placeholder="Distillery" />
    <input type="text" id="age" placeholder="Age" />
    <input type="text" id="proof" placeholder="Proof" />
    <button type="submit">Add Bottle</button>
  </form>
</div>

<div class="controls">
  <label><input type="checkbox" id="filterFavorite" /> Show only Favorites</label>
  <label><input type="checkbox" id="filterRare" /> Show only Rare</label>
  <label><input type="checkbox" id="filterKilled" /> Show only Killed</label>

  <label for="sortBy">Sort by:</label>
  <select id="sortBy">
    <option value="name">Name (A–Z)</option>
    <option value="age">Age (low → high)</option>
    <option value="proof">Proof (low → high)</option>
  </select>
</div>

<div class="bottle-grid" id="bottleGrid"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs,
    updateDoc, deleteDoc, doc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const role = localStorage.getItem("bungholeRole");
  const access = localStorage.getItem("bungholeAccess");

  if (!access || !role) window.location.href = "signin.html";

  document.addEventListener("DOMContentLoaded", () => {
    if (role !== "admin") {
      document.querySelector(".collapsible").style.display = "none";
      document.querySelector(".content").style.display = "none";
    }
  });

  const firebaseConfig = {
    apiKey: "AIzaSyAxvLgYQOOxx8QIqVckgEdjHpDlYTzcwGs",
    authDomain: "tipsy-bunghole-photos.firebaseapp.com",
    projectId: "tipsy-bunghole-photos",
    storageBucket: "tipsy-bunghole-photos.appspot.com",
    messagingSenderId: "223660009700",
    appId: "1:223660009700:web:yourappid"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const bottlesRef = collection(db, "bottles");

  const form = document.getElementById("bottleForm");
  const bottleGrid = document.getElementById("bottleGrid");

  const filters = {
    favorite: false,
    rare: false,
    killed: false,
    sortBy: "name"
  };

  // UI filter elements
  document.getElementById("filterFavorite").addEventListener("change", e => {
    filters.favorite = e.target.checked;
    renderFiltered();
  });
  document.getElementById("filterRare").addEventListener("change", e => {
    filters.rare = e.target.checked;
    renderFiltered();
  });
  document.getElementById("filterKilled").addEventListener("change", e => {
    filters.killed = e.target.checked;
    renderFiltered();
  });
  document.getElementById("sortBy").addEventListener("change", e => {
    filters.sortBy = e.target.value;
    renderFiltered();
  });

  const allBottles = [];

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const newBottle = {
      name: form.name.value,
      distillery: form.distillery.value,
      age: form.age.value,
      proof: form.proof.value,
      killed: false,
      favorite: false,
      rare: false,
    };
    await addDoc(bottlesRef, newBottle);
    form.reset();
  });

  onSnapshot(bottlesRef, (snapshot) => {
    allBottles.length = 0;
    snapshot.forEach(docSnap => {
      allBottles.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderFiltered();
  });

  function renderFiltered() {
    let filtered = allBottles.filter(b => {
      if (filters.favorite && !b.favorite) return false;
      if (filters.rare && !b.rare) return false;
      if (filters.killed && !b.killed) return false;
      return true;
    });

    if (filters.sortBy === "name") {
      filtered.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    } else if (filters.sortBy === "age") {
      filtered.sort((a, b) => (parseFloat(a.age) || 0) - (parseFloat(b.age) || 0));
    } else if (filters.sortBy === "proof") {
      filtered.sort((a, b) => (parseFloat(a.proof) || 0) - (parseFloat(b.proof) || 0));
    }

    renderBottles(filtered);
  }

  function renderBottles(bottles) {
    bottleGrid.innerHTML = "";
    bottles.forEach(b => {
      const card = document.createElement("div");
      card.className = "bottle-card";

      const makeField = (label, field, fallback = "N/A") => {
        const editable = role === "admin" ? "true" : "false";
        const container = document.createElement("div");
        container.innerHTML = `<strong>${label}:</strong> <span contenteditable="${editable}" class="field-${field}">${b[field] || fallback}</span>`;
        return container;
      };

      card.appendChild(makeField("Name", "name", "Unnamed"));
      card.appendChild(makeField("Distillery", "distillery"));
      card.appendChild(makeField("Age", "age"));
      card.appendChild(makeField("Proof", "proof"));

      const toggles = document.createElement("div");
      toggles.className = "toggle-group";

      ["killed", "favorite", "rare"].forEach(field => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" ${b[field] ? "checked" : ""} ${role !== "admin" ? "disabled" : ""}/> ${field}`;
        if (role === "admin") {
          label.querySelector("input").addEventListener("change", async () => {
            await updateDoc(doc(db, "bottles", b.id), {
              [field]: label.querySelector("input").checked
            });
          });
        }
        toggles.appendChild(label);
      });

      if (role === "admin") {
        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn";
        editBtn.innerHTML = "✏️";
        editBtn.addEventListener("click", async () => {
          const spans = card.querySelectorAll("span[contenteditable='true']");
          let updates = {};
          spans.forEach(span => {
            const field = span.className.replace("field-", "");
            const isEditable = span.getAttribute("contenteditable") === "true";
            span.setAttribute("contenteditable", !isEditable);
            if (!isEditable) span.focus();
            else updates[field] = span.innerText.trim();
          });
          if (Object.keys(updates).length > 0) {
            await updateDoc(doc(db, "bottles", b.id), updates);
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "🗑️";
        deleteBtn.addEventListener("click", async () => {
          if (confirm("Delete this bottle?")) {
            await deleteDoc(doc(db, "bottles", b.id));
          }
        });

        card.appendChild(editBtn);
        card.appendChild(deleteBtn);
      }

      card.appendChild(toggles);
      bottleGrid.appendChild(card);
    });
  }

  document.querySelector(".collapsible")?.addEventListener("click", function () {
    this.classList.toggle("active");
    const content = this.nextElementSibling;
    content.style.display = content.style.display === "block" ? "none" : "block";
  });
</script>

</body>
</html>
